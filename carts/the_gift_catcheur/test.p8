pico-8 cartridge // http://www.pico-8.com
version 18
__lua__
--the gift catcher
--theo5607

------------------
--variables
ctime = {
	ms=0,
	s=0,
	m=0
}

actors = {}
gifts = {}
boosts = {}
rocks = {}
explosions = {}

timer_boost = 0

gift_count = 0
gift_speed = 1

boost_speed=1

rock_anim_index={28,29,30,31}

game_over_ok=false

debut=true

------------------
--fonctions de base de pico8

function _init()
	p = make_actor(64,108,1)
	p.score=0
	p.boosts=0
	p.tag=1
	p.dg=1
	p.dd=1
	p.sp1=1
	p.sp2=2
	p.live=6
end

function _update()
	if debut==true then
		if btn(4) and btn(5) then
			debut=false
		end
	end
	
	if debut==false then
		if game_over_ok==false then
			if (btn(0)) then
				if p.x>0 then
					p.x -= p.dg
				end
			end
				
			if (btn(1)) then
				if p.x<120 then
			 	p.x += p.dd
			 end
			end
			
			new_item()
			move_gift()
			move_boost()
			move_rock()
			coll_items()
			coll_floor()
			debut_boost()
			
			anim_player()
			anim_rock()
						
			game_over()
		end
		
		if timer_boost>60 then
			fin_boost()
		elseif timer_boost>0 then
			timer_boost+=1
		end
			
		time_manager()
		
		if game_over_ok==true then
			if btn(4) and btn(5) then
				new_game()
			end
		end
	end
end

function _draw()
	if debut==false then
		if game_over_ok==false then
			cls(7)
			draw_actors()
			draw_explosions()
			draw_scene()
			draw_score()
			draw_live()
		elseif game_over_ok==true then
			spr(37,48,40,4,2)
			spr(32,44,70,5,2)
			spr(23,101,119)
			spr(27,p.x,p.y)
			spr(26,p.x,p.y)
		end
	end
	
	if debut==true then
		cls()
		spr(64,20,20,8,2)
		spr(72,100,40,2,2)
		spr(32,44,60,5,2)
	end
end

------------------
--autres fonctions

--fonctions animation joueur et rocher

function anim_player()
	if ctime.ms==0 or ctime.ms==15 then
		if p.sprite==p.sp1 then
			p.sprite=p.sp2
		else
			p.sprite=p.sp1
		end
	end
end

function anim_rock()
	for r in all(rocks) do
		if ctime.ms==0 or ctime.ms==7 or
					ctime.ms==15 or ctime.ms==22 then
			if r.anim_index==3 then
				r.anim_index=0
				r.sprite=rock_anim_index[r.anim_index+1]
			else
				r.anim_index+=1
				r.sprite=rock_anim_index[r.anim_index+1]
			end
		end
	end
end

--fonctions collisions

function coll_items()
	for a in all(actors) do
		if check_coll(a) == true then
			if a.tag==2 then
				make_explosion(a.x+3,a.y+3,10,4)
				p.score+=1
				del(gifts, a)
				del(actors, a)
			elseif a.tag==3 then
				make_explosion(a.x+3,a.y+3,14,6)
				p.boosts+=1
				del(boosts, a)
				del(actors, a)
			elseif a.tag==4 then
				make_explosion(a.x+3,a.y+3,13,7)
				del(rocks, a)
				del(actors, a)
				p.live-=1
			end
		end
	end
end

function check_coll(g)
	local box_p = get_box(p)
	local box_g = get_box(g)
	if box_p.x1 > box_g.x2 or
				box_p.y1 > box_g.y2 or
				box_g.x1 > box_p.x2 or
				box_g.y1 > box_p.y2 then
			return false
	end
	return true
end

function get_box(a)
	local box = {}
	box.x1 = a.x + a.box.x1
	box.y1 = a.y + a.box.y1
	box.x2 = a.x + a.box.x2
	box.y2 = a.y + a.box.y2
	return box
end

function coll_floor()
	for g in all(gifts) do
		if g.y>=119 then
			del(gifts,g)
			p.live-=1
		end
	end
end

--fonction nouvel item

function new_item()
	if ctime.s != 0 and ctime.s%20==0 and ctime.ms==0 then
		b = make_actor(rnd(120),-8,14)
		b.tag=3
		b.box.y1=1
		add(boosts,b)
	elseif ctime.s%2==0 and ctime.ms==0 then
		g = make_actor(rnd(120),-8,3)
		g.tag=2
		gift_count+=1
		if gift_count%50==0 and gift_count!=0 then
			gift_speed+=0.1
		end
		add(gifts,g)
	end
	
	if flr(rnd(210))==10 then
		r = make_actor(rnd(120),-8,28)
		r.tag=4
		r.anim_index=0
		add(rocks,r)
	end
end

--fonction mouvement cadeaux

function move_gift()
	for g in all(gifts) do
		g.y+=gift_speed
	end
end

--fonctions boost

function move_boost()
	for b in all(boosts) do
		b.y+=boost_speed
	end
end

function debut_boost()
	if btnp(4) and timer_boost==0 then
		if p.boost==0 then
		
		elseif p.boosts>0 then
			make_explosion(p.x+3,p.y+3,21,5)
			p.boosts-=1
			p.dg=3
			p.dd=3
			p.sp1=21
			p.sp2=22
			timer_boost+=1
		end
	end
end

function fin_boost()
	p.sp1=1
	p.sp2=2
	p.dd=1
	p.dg=1
	timer_boost=0
end

--fonction rocher

function move_rock()
	for r in all(rocks) do
		r.y+=2
	end
end

--fonctions explosions

function make_explosion(x,y,c,r)
	explo = {}
	explo.x = x
	explo.y = y
	explo.r = r
	explo.c = c
	add(explosions,explo)
end

function draw_explosions()
	for e in all(explosions) do
		circfill(e.x,e.y,e.r,e.c)
		e.r-=1
	end
end

--fonction game over

function game_over()
	if p.live<=0 then
		p.dd=0
		p.dg=0
		gift_speed=0
		boost_speed=0
		p.sp1=26
		p.sp2=26
		game_over_ok=true
	end
end

------------------
--fonctions basiques appelees
--dans update

--fonction acteurs

function make_actor(x,y,sprite)
	local actor = {}
	actor.x = x
	actor.y = y
	actor.sprite = sprite
	actor.box = {x1=0, y1=0, x2=7, y2=7}
	add(actors,actor)
	return actor
end

function draw_actors()
	for a in all(actors) do
		spr(a.sprite,a.x,a.y)
	end
end

--fonction gestion du temps

function time_manager()
	ctime.ms+=1
	if ctime.ms>=30 then
		ctime.ms=0
		ctime.s+=1
		if ctime.s>=60 then
			ctime.m+=1
		end
	end
end

--fonctions dessin score et scene

function draw_score()
	spr(4+flr(p.score/100),0,120)
	spr(4+flr((p.score%100)/10),8,120)
	spr(4+p.score%10,16,120)
end

function draw_scene()
	for i=0,20 do
		spr(18,0+i*8,112)
	end
	
	for i=4,20 do
		spr(16,0+i*8,120)
	end
	
	spr(17,24,120)
	spr(19,24,112)
	
	spr(4+p.boosts,40,120)
	spr(20,48,119)
end

function draw_live()
	for i=0,2 do
		spr(23,101+i*9,119)
	end
	
	for i=0,flr(p.live/2)-1 do
		spr(25,101+i*9,119)
	end
	
	if p.live%2!=0 then
		spr(24,101+9*(flr(p.live/2)),119)
	end
end

------------------
--fonction de nouvelle partie

function new_game()
	for a in all(actors) do
		del(actors,a)
	end
	
	for g in all(gifts) do
		del(gifts,g)
	end
	
	for b in all(boosts) do
		del(boosts,b)
	end
	
	p=make_actor(64,108,1)
	p.score=0
	p.boosts=0
	p.dg=1
	p.dd=1
	p.sp1=1
	p.sp2=2
	p.live=6
	
	timer_boost = 0

	gift_count = 0
	gift_speed = 1
	
	boost_speed=1
	
	game_over_ok=false
end
__gfx__
00000000008008000080080000900900dd8888dddddd8dddddd888dddd888dddddddd8ddd88888dddd888dddd888888ddd8888dddd8888dd0000000000000000
00000000080000800080080009099090d8dddd8dddd88ddddd8ddd8dd8ddd8dddddd88ddd8ddddddd8dddddddddddd8dd8dddd8dd8dddd8d0ccccc0000000000
00700700800000080800008000900900d8dddd8ddd8d8ddddddddd8dddddd8ddddd8d8ddd8ddddddd8ddddddddddd88dd8dddd8dd8dddd8dcaccacc000000000
000770008088880880888808bbb99bbbd8dddd8ddddd8dddddddd8dddddd8ddddd8dd8ddd8888dddd8888ddddddd88dddd8888dddd8888ddccaccacc00000000
000770000898898088988988bbb99bbbd8dddd8ddddd8ddddddd8dddddddd8ddd88888ddddddd8ddd8ddd8ddddd88dddd8dddd8ddddddd8dcccaccac00000000
00700700088888800888888099999999d8dddd8ddddd8dddddd8ddddd8ddd8ddddddd8ddddddd8ddd8ddd8dddd88ddddd8dddd8dddddd8ddccaccacc00000000
000000000898898008988980bbb99bbbdd8888dddd88888ddd88888ddd888dddddddd8ddd88888dddd888dddd88ddddddd8888dddd888dddcaccacc000000000
000000000089980000899800bbb99bbbdddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddd0ccccc0000000000
ddddddddd9d99d9d0000000000000000dddddddd0030030000300300080000800800008008000080000000007777777705555550055555500555555005555550
dddddddddd9dd9dd0000000000000000dcccccdd03000030003003008080080888800808888008880000000077777777555dd55555dddd5555555d55555dd555
ddddddddbbb99bbb0000000000000000caccaccd300000030300003080088008888880088888888800000000777777775d555d555d5555555ddd55d555d555d5
ddddddddbbb99bbb0000000000000000ccaccacc303333033033330380000008888800088888888800888800777777775d555d55555d55d55555d5d555d555d5
dddddddd999999990000000000000000cccaccac039339303393393380000008888800088888888888988988777777775d5d555555d555d555d555d55555d5d5
ddddddddbbb99bbb0000000000000000ccaccacc033333300333333008000080088800800888888088888888777777775d55ddd555d5dd5555d555d55ddd55d5
ddddddddbbb99bbbddddddddddddddddcaccaccd0399993003999930008008000088080000888800888998887777777755d5555555d55555555dd55555555d55
dddddddddddddddddddddddddd9dd9dddcccccdd0033330000333300000880000008800000088000808888087777777705555550055555500555555005555550
aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa0099999009999900900000909999999000000000000000000000000000000000000000000000000000000000
aeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeea0900000090000090990009909000000000000000000000000000000000000000000000000000000000000000
aeee777e777e77ee77ee77eee7e7eeeeee77eeea0900000090000090909090909000000000000000000000000000000000000000000000000000000000000000
aeee7e7e7e7e7ee7eee7eeeee7e7ee7ee7eeeeea0909990099999990900900909999990000000000000000000000000000000000000000000000000000000000
aeee777e777e77e77ee77eeeee7ee777e7eeeeea0900009090000090900000909000000000000000000000000000000000000000000000000000000000000000
aeee7eee77ee7eeee7eee7eee7e7ee7ee7eeeeea0900009090000090900000909000000000000000000000000000000000000000000000000000000000000000
aeee7eee7e7e77e77ee77eeee7e7eeeeee77eeea0099999090000090900000909999999000000000000000000000000000000000000000000000000000000000
aeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeea0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
aeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeea0999999090000090999999909999999000000000000000000000000000000000000000000000000000000000
ae777e777eee777e77ee77e777e777e777e777ea0900009099000990900000009000009000000000000000000000000000000000000000000000000000000000
aee7ee7e7eee7e7e7ee7eeee7ee7e7e7e7ee7eea0900009009000900900000009000009000000000000000000000000000000000000000000000000000000000
aee7ee7e7eee777e77e77eee7ee777e777ee7eea0900009009909900999999009999999000000000000000000000000000000000000000000000000000000000
aee7ee7e7eee77ee7eeee7ee7ee7e7e77eee7eea0900009000909000900000009990000000000000000000000000000000000000000000000000000000000000
aee7ee777eee7e7e77e77eee7ee7e7e7e7ee7eea0900009000999000900000009099990000000000000000000000000000000000000000000000000000000000
aeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeea0999999000090000999999909000099000000000000000000000000000000000000000000000000000000000
aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
aaaaaaaa0aa000aa0aaaaaaa0000aaaaa00aaaa0aaaaa0aaaaaaaa00000000000000000000000000000000000000000000000000000000000000000000000000
aaaaaaaa0aa000aa0aaaaaaa000a00000000aa00aaaaa0aaaaaaaa00000000008080000000000808000000000000000000000000000000000000000000000000
000aa0000aaaaaaa0a000000000a00000000aa00aa0000000aa00000000000008880000000000888000000000000000000000000000000000000000000000000
000aa0000aaaaaaa0aaaaaa0000a00aaa000aa00aaaaa0000aa00000000000000800000000000080000000000000000000000000000000000000000000000000
000aa0000aa000aa0a000000000a00000a00aa00aaaaa0000aa00000000000000800000000000080000000000000000000000000000000000000000000000000
000aa0000aa000aa0aaaaaaa000a00000a00aa00aa0000000aa00000000000000800008888000080000000000000000000000000000000000000000000000000
000aa0000aa000aa0aaaaaaa0000aaaaa00aaaa0aa0000000aa00000000000000800888888880080000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000800888888888080000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000888899889988880000000000000000000000000000000000000000000000000
000aaaaa00aaaa00aaaaaaaa00aaaaa0aa000aa0aaaaaaa0aa000aa0aaaaaa000008899889988000000000000000000000000000000000000000000000000000
00a000000a0000a0aaaaaaaa0a000000aa000aa0aaaaaaa0aa000aa0a0000a000008888888888000000000000000000000000000000000000000000000000000
00a000000a0000a0000aa0000a000000aaaaaaa0a0000000aa000aa0a0000a000008888888888000000000000000000000000000000000000000000000000000
00a000000a0000a0000aa0000a000000aaaaaaa0aaaaaaa0aa000aa0aaaaaa000008898888988000000000000000000000000000000000000000000000000000
00a000000aaaaaa0000aa0000a000000aa000aa0a0000000aa000aa0aaa000000008889999888000000000000000000000000000000000000000000000000000
00a000000a0000a0000aa0000a000000aa000aa0aaaaaaa0aaaaaaa0a00aa0000000888888880000000000000000000000000000000000000000000000000000
000aaaaa0a0000a0000aa00000aaaaa0aa000aa0aaaaaaa00aaaaa00a0000a000000008888000000000000000000000000000000000000000000000000000000
__map__
000000000000000000001c570000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000000000000001c1c0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000001c0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000001c1c1c1c1c1c1c1c1c00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000001c1c1c0000001c1c1c00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000001c1c1c1c1c1c1c1c1c1c00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000001c1c1c1c1c1c1c00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000001c1c0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
